#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>

/******************************
 動的メモリ確保関連の関数群
******************************/
void *xmalloc(size_t size) {
    void *p;
    p = malloc(size);
    if (!p) {
        printf("faiied malloc");
        exit(1);
    }
    return p;
}

void *xcalloc(size_t num, size_t size) {
    void *p;
    p = calloc(num, size);
    if (!p) {
        printf("failed calloc");
        exit(1);
    }
    return p;
}


/******************************
 進数変換関連の関数群
******************************/

// Hex2Decの本体。A~Fまでがintに変換されたtargetを受け取って、10進数に変換する
// Hex2DecMainが再帰するたびにmultiが次々16で割られていく。それをindex回続ける。
// multiは初期状態で16^(整数桁-1)である必要がある。
// 最上位桁から最下位桁までその桁の重みを掛けて、加算する。
float Hex2DecMain(int *target, float multi, int index) {
    if (index == 1) {
        return *target * multi;
    } else {
        return (*target * multi) + Hex2DecMain(++target, multi/16, --index);
    }
}

// Change Hex symbolの略。A~Fまでをintに変換し、配列に詰め込む。
void CHexSymbol(char *symbol, int *target) {
    if (*symbol) {
        *target = *symbol - (int)'A' + 10;
        CHexSymbol(++symbol, ++target);
    }
}

// Hex to Decimalの略。16進数から10進数に変換する。少数にも対応している。
// 進数変換の他の関数に引数を揃えている。
// multiは初期状態で16^(整数桁-1)である必要がある。
// indexは整数部の桁数
float Hex2Dec(char *symbol, float multi, int index) {
    int *target;
    float result;
    
    target = (int*)xcalloc(index, sizeof(int));
    
    CHexSymbol(symbol, target);
    result = Hex2DecMain(target, multi, index);

    free(target);
    return result;
}

// Octal to Decimalの略。16進数から10進数に変換する。少数にも対応している。
// Oct2Decが再帰するたびにmultiが次々8で割られていく。それをindex回続ける。
// multiは初期状態で8^(整数桁-1)である必要がある。
// 最上位桁から最下位桁までその桁の重みを掛けて、加算する。
// indexは整数部の桁数
float Oct2Dec(int *target, float multi, int index) {
    if (index == 1) {
        return *target * multi;
    } else {
        return (*target * multi) + Oct2Dec(++target, multi/8, --index);
    }
}

int main() {
    char HexTarget[] = "CF";
    int digit;
    /******************************
     1. 16進数 CFを10進数で表わせ
    ******************************/
    // HexTargetの桁数を調べる
    digit = strlen(HexTarget);

    // Hex2Decにデータを投げて直接printfで出力する。
    printf("CF(16) = %d\n", (int)Hex2Dec(HexTarget, pow(16, digit-1), digit));


    /******************************
     2. 8進数 362を10進数で表わせ
    ******************************/
    int OctTarget[] = {3,6,2};
    // OctTargetの整数部の桁数
    digit = 3;

    // Hex2Decにデータを投げて直接printfで出力する。
    printf("362(8) = %d\n", (int)Oct2Dec(OctTarget, pow(8, digit-1), digit));
    return 0;
}
